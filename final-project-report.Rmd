---
title: 'STAT 471: Final Project'
author: 'Leontij Potupin, Rachel Wu'
date: 'December 8, 2021'
output:
  bookdown::pdf_document2:
    number_sections: yes
    toc: yes
    toc_depth: '3'
  html_document:
    highlight: haddock
    number_sections: yes
    theme: lumen
    toc: no
    toc_depth: 4
    toc_float: yes
urlcolor: blue
---

## Introduction

## Downloading Data
```{r, message = FALSE}
library(keras)         # to train neural networks
library(kableExtra)    # to print tables
library(cowplot)       # to print side-by-side plots
library(tidyverse)     # tidyverse
library(tensorflow)
library(dplyr)
library(haven)
library(pROC) # for ROC curves
library(ggplot2)
library(haven)
```
```{r, eval=FALSE}

url_2019 = "https://ftp.cdc.gov/pub/Health_Statistics/NCHS/dataset_documentation/nhamcs/stata/ED2019-stata.zip"
url_2018 = "https://ftp.cdc.gov/pub/Health_Statistics/NCHS/dataset_documentation/nhamcs/stata/ED2018-stata.zip"
url_2017 = "https://ftp.cdc.gov/pub/Health_Statistics/NCHS/dataset_documentation/nhamcs/stata/ed2017-stata.zip"
url_2016 = "https://ftp.cdc.gov/pub/Health_Statistics/NCHS/dataset_documentation/nhamcs/stata/ED2016-stata.zip"
url_2015 = "https://ftp.cdc.gov/pub/Health_Statistics/NCHS/dataset_documentation/nhamcs/stata/ED2015-stata.zip"
temp = tempfile()
download.file(url_2019,temp)
data_2019 = read_dta(unz(temp,"ED2019-stata.dta"))

temp = tempfile()
download.file(url_2018,temp)
data_2018 = read_dta(unz(temp,"ED2018-stata.dta"))

temp = tempfile()
download.file(url_2017,temp)
data_2017 = read_dta(unz(temp,"ed2017-stata.dta"))

temp = tempfile()
download.file(url_2016,temp)
data_2016 = read_dta(unz(temp,"ED2016-stata.dta"))

temp = tempfile()
download.file(url_2015,temp)
data_2015 = read_dta(unz(temp,"ED2015-stata.dta"))

head(data_2019)
head(data_2018)
head(data_2017)
head(data_2016)
head(data_2015)
```

## Data Wrangling
```{r, eval=FALSE}
data_raw = bind_rows(data_2015, data_2016, data_2017, data_2018, data_2019)
head(data_raw)
#View(data_raw)
```
#Clean missing data and delete variables with too few entries
```{r}
#THINGS TO DO: CTCONTRAST LEAVE IN OR OUT, DIAG2R TAKE OUT -9 ROWS OR SCRAP WHOLE COLUMN?
      #Do we keep PRDIAG2 & 3? check with
                #nrow(data_clean_delete_var[data_clean_delete_var$PRDIAG2==-7, ])
      #CHANGE VARIABLES TO FACTORS FROM DOUBLES (PROBABLY DO QUICK SCAN IF ONLY HAS 2 UNIQUE VAR)
      #CLEAN OBSSTAY-> -7s, & IMPUTE MEANS FOR LOV PAINSCALE POPCT BPDIAS BPSYS





#Notes: -7 codes for Not Applicable, -9 codes for Blank, "Blank"
#order columns alphabetically
data_raw_ordered = data_raw[,order(colnames(data_raw))]
#Imput missing data
data_clean_delete_missing <- data_raw_ordered[!(data_raw_ordered$ADMDIV < 0 | #controversial to keep
                                                  data_raw_ordered$AMBTRANSFER < 0 | #controversial to keep
                                                  data_raw_ordered$RESIDNCE < 0 |
                                                  data_raw_ordered$RESPR < 0 |
                                                  data_raw_ordered$TEMPF < 0 |
                                                  data_raw_ordered$TEMPDF < 0 |
                                                  data_raw_ordered$PULSE < 0 |
                                                  data_raw_ordered$TOTDIAG < 0 |
                                                  data_raw_ordered$TOTPROC < 0 |
                                                  data_raw_ordered$WAITTIME < 0 |
                                                  data_raw_ordered$WAITTIME < 0) |
                                                  !is.na(data_raw_ordered$PRESCR1) |
                                                  !is.na(data_raw_ordered$PRESCR2) |
                                                  !is.na(data_raw_ordered$CONTSUB1) |
                                                  !is.na(data_raw_ordered$CONTSUB2), ]

#Delete all the char variables, will not work in the glm_fit, cuts col from 1058 to 521
data_clean_delete_char <- data_clean_delete_missing[, sapply(data_clean_delete_missing, 
                                                             function(x) !is.character(x))]
#Delete certain variables taken post/at discharge
data_clean_delete_var <- data_clean_delete_char %>% 
  select(-c(AGER, AGEDAYS, ADISP, LOS,
            RFV4, RFV5, 
            RFV43D, RFV53D, 
            PRDIAG4, PRDIAG5,
            MRICONTRAST, MED10:MED30,
            GPMED4:GPMED30,
            LEFTBTRI:DIEDED, ADMIT, ADMTPHYS, AGEFL, BLANK1, BLANK2, 
            BLANK3, BLANK4, CPSUM, CSTRATM, COMSTAT1:COMSTAT9,EDWT, 
            HOSPCODE, LBTC, LWBS, MSA, OBSDIS, OBSHOS, 
            PATCODE, PATWT, PULSED, RACERFL, RESPRD, PTONLINEE1: PTONLINEE6,
            RFID, SEXFL, TEMPDF, TRANNH, TRANOTH, TRANPSYC, VITALSD , YEAR))

#Delete these variables with >90% NA or -9, no way to impute, ncol/variables 234 to 179
data_clean_delete_var <- data_clean_delete_var %>%
  select(-c(BOARDED, CAUSE1R:CAUSE3R,
            CONTSUB10:CONTSUB19, CONTSUB20:CONTSUB9, 
            DIAG3R:DIAG5R, PRESCR10:PRESCR19,
            PRESCR20:PRESCR29, PRESCR6:PRESCR9))

#Delete these variables with 50% NA or -9
data_delete_var <- data_clean_delete_var %>% 
  select(-c(MED4:MED9, PRESCR3:PRESCR5, REGDIV, TOTHRDIVR))
```
#Create factors from doubles
```{r}
data_factored <- data_delete_var
keep_double <- c("AGE", "BPDIAS", "BOARDED", "BPSYS", 
                "NUMDIS", "NUMGIV", "NUMMED", "OBSSTAY", 
                 "PAINSCALE", "POPCT", "PULSE", "RESPR", "SURGDAY", 
                 "TOTCHRON", "TOTDIAG", "TOTPROC", "WAITTIME")

col_names <- names(data_factored)
data_factored[,col_names] <- lapply(data_factored[,col_names] , as.factor)
#as_factor(x = levels = "values")

data_factored[ , keep_double] <- lapply(data_factored[ , keep_double], as.numeric)

# job_clean <- job_satisfaction %>% mutate(income = ordered(Income, 
#         c(levels=c("<5000", "5000-15000", "15000-25000", ">25000")))) %>% 
#   mutate(job = ordered(Satisfaction,
#         levels=c("Very Dissatisfied", "A Little Satisfied", 
#                  "Moderately Satisfied", "Very Satisfied"))) %>%
#   mutate(Gender = ordered(Gender, levels=c("Female", "Male")))

```
#Imputing means
```{r}
#Find the means for each column for imputing
#LOV replace -7, -9 and PAINSCALE replace -8, POPCT, BPDIAS,BPSYS
means <- apply(data_factored, 2, function(x) {
  mean(x[x>0])
  })

#for loop to fill keep_double 



#################For testing
#nrow(data_clean_delete_var[data_clean_delete_var$LOV==-7, ])
#sum(is.na(data_clean_delete_var$CONTSUB16))
#sapply(lapply(data_clean_delete, unique), length)
#sapply(data_factored, typeof)
#Number of variables left
#ncol(data_delete_var)
```

Removing empty columns, remove gpmed variables because numGiv gives you sum of # gpmed per patient, removing LEFTBTRI:DIEDED because these patients are not admitted into the ED (therefore cannot be admitted to hospital) or they died before they could be admitted to hosptial (dead on arrival or died in the ED).

## Train & Test Split
```{r}
train_samples = sample(1:nrow(data_clean_delete), 0.8*nrow(data_clean_delete))
admit_train = data_clean_delete %>% filter(row_number() %in% train_samples)
admit_test = data_clean_delete %>% filter(!(row_number() %in% train_samples))
```

## Data Description and Exploration
**Our response variable is ADMITHOS, which is a categorical variable assigned a 1 if the patient was admitted to this hospital and 0 if they were not admitted. We have several similar variables that tell us information on patient disposition, ie where a patient went after appearing at the hospital. OBSHOS (indicating patients were admitted to the hospital after observation in the emergency department), TRANPYSC (patient transferred to a psychiatric hospital), and TRANOTH (patient was transferred to another hospital) were also variables that indicate the patient experienced additional care after being seen in the emergency department. However, we decided to focus only on ADMITHOS because of the clarity of the variable compared to the other potential response variables. TRANPYSC could indicate the patient went to a pyschiatric hospital but may not have been admitted to that hospital; the same concern plagues the TRANOTH variable. OBSHOS is also binary and for every positive OBSHOS observed, there is also a positive ADMITHOS value for that given patient, so we**
```{r}
data_clean_delete %>%
  group_by(ADMITHOS) %>%
  summarise(cnt = n()) %>%
  mutate(freq = round(cnt / sum(cnt), 3))
```
**Around 9.9% of people were admitted to the hospital.**

## Model Building, Evaluation, and Interpretation

### Linear Regression

### Logistic Regression

```{r}
glm_fit = glm(ADMITHOS ~ RACEUN + ARREMS + PAYTYPER + ABG + CONTSUB28,
              family = "binomial",
              data = admit_train)
# glm_fit = glm(ADMITHOS ~ .,
#               family = "binomial",
#               data = admit_train)
coef(glm_fit)

fitted_probabilities = predict(glm_fit,
        newdata = admit_test,
type = "response") # to get output on probability scale head(fitted_probabilities)

predictions = as.numeric(fitted_probabilities > 0.5)

admit_test = admit_test %>%
  mutate(predicted_admit = predictions)

# then calculate misclassification rate
admit_test %>%
    summarise(mean(ADMITHOS != predicted_admit))

#confusion matrix
admit_test %>%
  select(ADMITHOS, predicted_admit) %>%
  table()
 
```
```{r}
# ROC Curve
# ROC curve
roc_data = roc(admit_test %>% pull(ADMITHOS),
               fitted_probabilities)
tibble(FPR = 1-roc_data$specificities,
       TPR = roc_data$sensitivities) %>%
  ggplot(aes(x = FPR, y = TPR)) +
  geom_line() +
  geom_abline(slope = 1, linetype = "dashed") +
#  geom_point(x = fpr, y = 1-fnr, colour = "red") +
  theme_bw()

# print the AUC
roc_data$auc
 
```
```{r}
admit_train %>%
  ggplot(aes(x = ABG, y = ADMITHOS))+
  geom_jitter(height = .05) +
  geom_smooth(method = "glm",
              formula = "y~x",
              method.args = list(family = "binomial"),
              se = FALSE) +
  ylab("Prob(ADMITHOS=1)") +
  theme_bw()
```






### Trees

### CNN

## Conclusions

## Appendix

